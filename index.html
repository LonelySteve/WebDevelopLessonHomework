<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8">
    <title>文件上传</title>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="css/control.css">
    <link rel="stylesheet" href="css/main.css">
</head>

<body>
    <div class="panel w85pct">

        <h2>文件列表</h2>

        <div class="nav">
            <div class="operate">
                <label for="file-upload-input" class="icon-btn upload">上传</label>
                <input type="file" id="file-upload-input" multiple="multiple" />
                <!-- <input type="text" name="search-keywords" id="text-search-keywords" class="edit-box"
                    placeholder="请输入搜索关键字" /> -->
            </div>
            <div class="file-path">
                <div class="navigate di mr5">
                    <span id="sub-operate" class="dn">
                        <span id="btn-download" class="icon-btn download"></span>
                        <!-- <span id="btn-rename" class="icon-btn edit"></span> -->
                        <span id="btn-delete" class="icon-btn delete-fill bc6 bch7 bca8"></span>
                    </span>
                    <span id="btn-add-folder" class="icon-btn folder-add"></span>

                    <span id="btn-reload" class="icon-btn reload"></span>
                </div>
                <div class="mt10">
                    <div class="di">
                        <span id="btn-prev" class="icon-btn arrowleft"></span>
                        <!--NOTE 没有用的前进键 -->
                        <!-- <span id="btn-next" class="icon-btn arrowright"></span> -->
                    </div>

                    <div class="path di" id="path-container">
                        <div class="root-item path-item"><span class="icon-btn disable-before">/</span></div>
                    </div>
                </div>
            </div>
        </div>

        <table class="normal-table w100pct" id="files-list">
            <thead>
                <th id="check-all-th"><span class="icon pr t2 w18b h18b checkbox--unchecked"></span></th>
                <th class="oh toe" title="名称">名称</th>
                <th class="oh toe" title="类型">类型</th>
                <th class="oh toe" title="大小">大小</th>
                <th class="oh toe" title="上传时间">上传时间</th>
            </thead>
            <tbody class="w100pct db h500">

            </tbody>
        </table>

    </div>

    <script>
        var current_workdir_path_items = [];
        var current_selected_names = [];
        var current_unselected_names = [];

        var file_icon_mapping = {
            "file-image-fill": ["jpg", "png", "gif"],
            "file-markdown-fill": ["md"],
            "file-pdf-fill": ["pdf"],
            "file-ppt-fill": ["ppt", "pptx"],
            "file-text-fill": ["txt"],
            "file-word-fill": ["doc", "docx"],
            "file-zip-fill": ["zip", "7z", "rar"],
            "file-excel-fill": ["xls", "xlsx"],
        };

        function get_cwd() {
            return current_workdir_path_items.join("/");
        }

        function get_file_icon(ext) {
            for (const file_icon_name in file_icon_mapping) {
                if (file_icon_mapping.hasOwnProperty(file_icon_name)) {
                    const exts = file_icon_mapping[file_icon_name];
                    if (exts.indexOf(ext) != -1)
                        return file_icon_name;
                }
            }
            return "file-unknown-fill";
        }

        function async_action(action, params, callback, cwd) {
            $.post("php/manager.php", {
                action: action,
                cwd: cwd || get_cwd(),
                params: params
            }, function (data, status) {
                if (status !== "success") {
                    alert("执行动作" + action + "出错！");
                    return;
                }
                if (data.code !== 0) {
                    alert("执行动作" + action + "出错！" + "出错原因：" + "[" + data.code + "]" + data.msg);
                }
                if (data.hasOwnProperty("data")) {
                    update_table(data.data);
                }
                if (data.code === 0 && callback) {
                    callback(data);
                }
            }, "json")
        }

        function update_current_workdir() {
            var $path = $(".path");
            $(".child-item").remove();
            current_workdir_path_items.forEach(path_item => {
                if (path_item) {
                    $path.append($("<div></div>")
                        .addClass("child-item path-item")
                        .append($("<span></span>").text(path_item)
                            .addClass("icon-btn disable-before")))
                }
            });
        }

        function update_table(data) {
            var $tbody = $("#files-list tbody");
            // 删除旧的表格主体内容
            $tbody.empty();
            // 重建未选择的名称数组
            current_unselected_names = [];
            // 渲染文件夹
            data.dirs.forEach(line_data => {
                var $tr = $('<tr class="w100pct db"></tr>');
                $tbody.append($tr);
                // 添加单选框
                $tr.append($("<td></td>").append($("<span></span>").addClass(
                    "icon w18b h18b checkbox--unchecked")));
                // 添加图标和名称 
                $tr.append($('<td class="oh toe tl"></td>').append($('<span class="name"></span>').addClass(
                    "icon w18b h18b").addClass("folder-fill").text(line_data.name)));
                // TODO 支持文件夹的大小和上传时间判断
                for (let index = 0; index < 3; index++) {
                    $tr.append($('<td class="oh toe"></td>').text("-"));
                }
                current_unselected_names.push(line_data.name);
            });
            data.files.forEach(line_data => {
                var $tr = $('<tr class="w100pct db"></tr>');
                $tbody.append($tr);
                // 添加单选框
                $tr.append($("<td></td>").append($("<span></span>").addClass(
                    "icon w18b h18b checkbox--unchecked")));
                // 添加图标和名称
                $tr.append($('<td class="oh toe tl"></td>').append($('<span class="name"></span>').addClass(
                    "icon w18b h18b").addClass(get_file_icon(line_data.type)).text(line_data.name)));
                // 添加剩余数据
                // TODO 人类可读的数据尺寸及上传时间
                $tr.append($('<td class="oh toe"></td>').text(line_data.type));
                $tr.append($('<td class="oh toe"></td>').text(line_data.size));
                $tr.append($('<td class="oh toe"></td>').text(line_data.upload_time));
                // 添加名称
                current_unselected_names.push(line_data.name);
            });
        }
        // TODO 支持关键字过滤
        function query_objs(keyword) {
            async_action("query", [keyword]);
        }

        function init_page() {
            async_action("query");
        }

        function change_dir(dir) {
            async_action("query", null, function (data) {
                current_workdir_path_items.push(dir);
                update_current_workdir();
            }, get_cwd() + '\\' + dir);
        }

        function remove_selected_items() {
            async_action("rm", current_selected_names, function (data) {
                current_selected_names = [];
            });
        }

        function select_items(names) {
            names.forEach((name) => {
                var i = current_unselected_names.indexOf(name);
                if (i < 0)
                    throw new Error("不存在指定文件:" + name);
                current_unselected_names.splice(i, 1); // 删除指定名称项
                current_selected_names.push(name);
            });
        }

        function unselect_items(names) {
            names.forEach((name) => {
                var i = current_selected_names.indexOf(name);
                if (i < 0)
                    throw new Error("不存在指定文件:" + name);
                current_selected_names.splice(i, 1); // 删除指定名称项
                current_unselected_names.push(name);
            })
        }

        function select_all_items() {
            current_unselected_names.forEach((name) => {
                current_selected_names.push(name);
            });
            current_unselected_names = [];
        }

        function unselect_all_items() {
            current_selected_names.forEach((name) => {
                current_unselected_names.push(name);
            });
            current_selected_names = [];
        }


        function get_filename($tr) {
            return $tr.find(".name").text();
        }

        $document = $(document);

        $document.ready(init_page);
        $document.ready(function () {
            $("#file-upload-input").change(
                // FIXME 上传大文件有问题
                function () {
                    var formData = new FormData(this);
                    formData.append("action", "upload");
                    formData.append("cwd", get_cwd());
                    formData.append("params", ["file"]);
                    Array.from(this.files).forEach(f => {
                        formData.append("file[]", f);
                    });
                    $.ajax({
                        url: "php/manager.php",
                        type: 'POST',
                        cache: false,
                        data: formData,
                        processData: false,
                        contentType: false,
                        dataType: "json",
                        beforeSend: function () {
                            uploading = true;
                        },
                        success: function (data, status) {
                            if (status !== "success") {
                                alert("执行动作" + action + "出错！");
                                return;
                            }
                            if (data.code !== 0) {
                                alert("执行动作" + action + "出错！" + "出错原因：" + "[" + data.code +
                                    "]" + data
                                    .msg);
                            }
                            if (data.hasOwnProperty("data")) {
                                update_table(data.data);
                            }
                        }
                    });
                }
            );

            var $tbody = $("#files-list tbody");
            document.oncontextmenu = new Function("return false;"); //禁止右键默认菜单

            $tbody.on({
                click: function () {
                    // FIXME 修复实际未选择任何项时，仍然能够使子操作台显示的BUG
                    $("#check-all-th").click(
                        function () {
                            var $span = $(this).find("span");
                            if ($span.hasClass("checkbox--checked")) {
                                $span.removeClass("checkbox--checked").addClass(
                                    "checkbox--unchecked");
                                // 取消全选
                                $('.checkbox--checked').removeClass("checkbox--checked")
                                    .addClass(
                                        "checkbox--unchecked");
                                unselect_all_items();
                                // 没有选中的项，将子操作隐藏
                                $("#sub-operate").hide();
                            } else if ($span.hasClass("checkbox--unchecked")) {
                                $span.removeClass("checkbox--unchecked").addClass(
                                    "checkbox--checked");
                                // 全选
                                $('.checkbox--unchecked').removeClass("checkbox--unchecked")
                                    .addClass(
                                        "checkbox--checked");
                                select_all_items();
                                // 有选中的项，取消子操作的隐藏
                                $("#sub-operate").show();
                            }
                        }
                    );

                    var $tr = $(this);
                    var checked_cb = $tr.find(".checkbox--checked");
                    var unchecked_cb = $tr.find(".checkbox--unchecked");
                    if (checked_cb.length > 0) {
                        // 取消选中
                        checked_cb.removeClass("checkbox--checked").addClass("checkbox--unchecked");
                        unselect_items([get_filename($tr)]);
                        var $check_all_span = $("#check-all-th").find("span");
                        if (current_selected_names.length == 0) {
                            $check_all_span.removeClass("checkbox--checked").addClass(
                                "checkbox--unchecked");
                            // 没有选中的项，将子操作隐藏
                            $("#sub-operate").hide();
                        }
                        // 只要取消某个选中，那么全选框就应该取消选中
                        if ($check_all_span.hasClass("checkbox--checked")) {
                            $check_all_span.removeClass("checkbox--checked").addClass(
                                "checkbox--unchecked");
                        }
                    }
                    if (unchecked_cb.length > 0) {
                        // 选中
                        unchecked_cb.removeClass("checkbox--unchecked").addClass(
                            "checkbox--checked");
                        select_items([get_filename($tr)]);
                        if (current_unselected_names.length == 0) {
                            $("#check-all-th").find("span").removeClass("checkbox--unchecked")
                                .addClass(
                                    "checkbox--checked");
                        }
                        // 有选中的项，取消子操作的隐藏
                        $("#sub-operate").show();
                    }
                },
                dblclick: function () {
                    $this = $(this);
                    // TODO 添加对非文件夹双击的处理逻辑
                    if ($this.find(".folder-fill").length) {
                        var name = get_filename($this);
                        change_dir(name);
                    }
                }
            }, "tr");

            $tbody.on({
                mouseup: function (e) {
                    var $sub_op = $("#sub-operate");
                    if (e.which === 3) {
                        $sub_op.addClass("pa");
                        $sub_op.css({
                            top: e.pageY - 10,
                            left: e.pageX - 10
                        });
                    } else {
                        $sub_op.removeClass("pa");
                    }
                }
            });

            $(document).mouseup(
                function (e) {
                    if (e.which !== 3) {
                        var $sub_op = $("#sub-operate");
                        $sub_op.removeClass("pa");
                    }
                }
            );
            // TODO 下载功能
            $("#btn-download").click(
                function () {
                    async_action("download", current_selected_names);
                }
            );
            // TODO 重命名功能
            $("#btn-rename").click(

            );
            // 删除所选文件
            $("#btn-delete").click(function () {
                remove_selected_items();
            });
            // 新建文件夹
            $("#btn-add-folder").click(
                function () {
                    var new_folder_name = prompt("请输入新文件夹名称");
                    if (new_folder_name) {
                        async_action("mkdir",[new_folder_name,]);
                    }
                }
            );
            // 路径切换
            $("#path-container").on("click", "span",
                function () {
                    $this = $(this);
                    var i = $this.parent("div").index();
                    if (i < current_workdir_path_items.length) {
                        current_workdir_path_items = current_workdir_path_items.slice(null, i);
                        async_action("query", null, function () {
                            update_current_workdir();
                        });
                    }
                }
            );
            // 刷新
            $("#btn-reload").click(
                function () {
                    async_action("query");
                }
            );
            // 后退
            $("#btn-prev").click(
                function () {
                    current_workdir_path_items.splice(current_workdir_path_items.length - 1, 1);
                    async_action("query", null, function () {
                        update_current_workdir();
                    });
                }
            );
        });
    </script>

</body>

</html>