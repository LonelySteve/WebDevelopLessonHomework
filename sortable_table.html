<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8">
    <title>作业六</title>
    <link rel="stylesheet" href="css/main.css">
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
</head>

<body>

    <div class="panel">
        <h2>班级成绩表</h2>
        <table id="class-grade-table" class="stagger-table" style="width:100%;">
            <thead>
                <th id="h-stu-num" class="sort-flag">学号</th>
                <th id="h-stu-name" class="sort-flag">姓名</th>
                <th id="h-stu-grade" class="sort-flag">成绩</th>
            </thead>
            <tbody>

            </tbody>
        </table>

    </div>

    <script>
        function get_sort_rule_flag(id) {
            var th = $("#" + id);
            if (th.hasClass("ascending"))
                return 1;
            else if (th.hasClass("descending"))
                return -1;
            else
                return 0;
        }

        function update_tables() {
            // 移除表格主体
            $("#class-grade-table tbody").children().remove();
            // TODO 支持调整排序优先级
            sort_priority = [0, 1, 2];
            // 获取排序规则要求
            sort_rules = {
                0: get_sort_rule_flag("h-stu-num"),
                1: get_sort_rule_flag("h-stu-name"),
                2: get_sort_rule_flag("h-stu-grade")
            }
            // 异步请求获取排序后的数据
            $.post("php/data.php", {
                "sort_rules": sort_rules,
                "sort_priority": sort_priority
            }, function (data, status) {
                if (data.code == 0) {
                    data.data.forEach(stu => {
                        var tr = $("<tr></tr>");
                        $("#class-grade-table tbody").append(tr);
                        stu.forEach(info => {
                            var td = $("<td></td>");
                            td.text(info);
                            tr.append(td);
                        });
                    });
                } else {
                    alert("未知错误，错误码：" + data.code);
                }

            }, "json");
        }

        $(document).ready(function () {
            update_tables();
            $(".sort-flag").click(function () {
                // 切换上下箭头
                var this_ = $(this);
                if (this_.hasClass("ascending"))
                    this_.removeClass("ascending").addClass("descending");
                else if (this_.hasClass("descending"))
                    this_.removeClass("descending");
                else
                    this_.addClass("ascending");
                update_tables();
            })
        });
    </script>

</body>

</html>